{
  "type": "code:0.0.1:local:32498h32f2",
  "name": "code",
  "data": {
    "key": "5f2da6d7-3b30-442d-b699-25f9a8b48ea7",
    "code": "(()=>{\n  return new Promise(async (resolve, reject)=>{\n    try {\n      \n      const { exec } = universe.require('child_process');\n      \n      // Expecting INPUT = standard_capability_action:0.0.1:local:298j291bs\n      \n      let cmdInputNode = INPUT.data.externalInputNode;\n      \n      if(cmdInputNode.type != 'standard_capability_action:0.0.1:local:298j291bs'){\n        console.log('Unexpected input schema');\n        return reject();\n      }\n      \n      let inputAction = cmdInputNode.data.action;\n      let inputOpts = cmdInputNode.data.options;\n      \n      // actions \n      // - sync: checks IPFS-host for pinned files, adds new ones (doesnt currently remove?) \n      \n      function asyncExec(opts){\n        return new Promise((resolve)=>{\n          exec(opts,(err, stdout, stderr)=>{\n            resolve({err, stdout, stderr});\n          })\n        });\n      }\n  \n      var ipfs = universe.sharedServices.ipfsApi;\n      \n      // start processing input\n      switch(inputAction){\n        case 'setup':\n          // setus up IPFS services on universe.sharedServices \n          \n          var ipfsPort = universe.env.IPFS_PORT || 5010,\n            ipfsProtocol = universe.env.IPFS_PROTOCOL || 'http',\n            ipfsHost = universe.env.IPFS_HOST || universe.env.DOCKHERO_HOST,\n            ipfsUsername = universe.env.IPFS_USER || 'testuser0',\n            ipfsPassword = universe.env.IPFS_PASSWORD || 'testpass0';\n          try {\n            console.log('IPFS Connection Params:', ipfsProtocol, ipfsHost, ipfsPort, ipfsUsername, ipfsPassword)\n            var ipfsAPI = universe.require('ipfs-api');\n            ipfs = ipfsAPI(ipfsHost, ipfsPort, {\n              protocol: ipfsProtocol,\n              headers: {\n                'Authorization': 'Basic ' + Buffer.from(ipfsUsername + ':' + ipfsPassword).toString('base64')\n              }\n            }) // leaving out the arguments will default to these values\n            \n            console.log('Testing connection...should be almost instant');\n            \n            var ipfsid = await ipfs.id();\n            \n            console.log('IPFS connected!:', ipfsid);\n            \n          }catch(err){\n            console.error('Failed ipfs-api (should restart!):', err);\n              \n            if(inputOpts && inputOpts.data && inputOpts.data.preventRestart){\n              // NOT restarting (failed, most likely) \n              return resolve({\n                type: 'boolean',\n                data: false\n              });\n            } else {\n              \n              // // shutdown server \n              // var {err, stdout, stderr} = await asyncExec('dh-compose exec sudo reboot');\n              // console.log(`Exec1 (reboot) Result: ${stdout} ${stderr}`);\n            \n              // await universe.sleep(30 * 1000);\n              \n              // // restart (using dockhero on heroku) if not running \n              // var {err, stdout, stderr} = await asyncExec('dh-compose down && dh-compose up -d --remove-orphans');\n              // console.log(`Exec2 Result: ${stdout} ${stderr}`);\n              \n              // console.log('--ONLY RUNNING dh-compose up, not any downs (p1)--');\n              // var {err, stdout, stderr} = await asyncExec('dh-compose up -d --remove-orphans');\n              // console.log(`Exec2 Result: ${stdout} ${stderr}`);\n              \n              // // restart ONLY ipfs service \n              // console.log('--Restart via dh-compose restart ipfs--');\n              // var {err, stdout, stderr} = await asyncExec('dh-compose restart ipfs');\n              // console.log(`Exec3 Result: ${stdout} ${stderr}`);\n              \n            \n              await universe.sleep(25 * 1000);\n              \n              // re-check if ipfs daemon is running now \n              var ipfsSetupResult = await universe.loadAndRunCapability('IPFS',{},{\n                type: 'standard_capability_action:0.0.1:local:298j291bs',\n                data: {\n                  action: 'setup',\n                  options: {\n                    type: 'ipfs_setup_options:Qmf230j23f232f3',\n                    data: {\n                      preventRestart: true\n                    }\n                  }\n                }\n              });\n              \n              // resolving original 'setup' \n              return resolve({\n                type: 'boolean',\n                data: true\n              });\n              \n            }\n            \n            return;\n            \n            // try and restart \n          }\n          universe.sharedServices.ipfsApi = ipfs;   \n          \n          return resolve({\n            type: 'boolean',\n            data: true\n          });\n          \n          \n        case 'restart-if-not-running':\n        \n          try {\n            var ipfsid = await ipfs.id();\n            \n            console.log('IPFS ok:', ipfsid);\n          \n            return resolve({\n              type: 'boolean',\n              data: true\n            });\n            \n          }catch(err){\n            console.log('IPFS not running, fucking restart is broken and never works consistently');\n            \n            // console.log('--NOT RESTARTING IPFS YET (doesnt work)--');\n              \n            // var {err, stdout, stderr} = await asyncExec('dh-compose exec sudo reboot');\n            // console.log(`Exec1 (reboot) Result: ${stdout} ${stderr}`);\n          \n            // await universe.sleep(30 * 1000);\n            \n            // // restart (using dockhero on heroku) if not running \n            // var {err, stdout, stderr} = await asyncExec('dh-compose down && dh-compose up -d --remove-orphans');\n            // console.log(`Exec2 Result: ${stdout} ${stderr}`);\n            \n            // console.log('--ONLY RUNNING dh-compose up, not any downs (p2)--');\n            // var {err, stdout, stderr} = await asyncExec('dh-compose up -d --remove-orphans');\n            // console.log(`Exec2 Result: ${stdout} ${stderr}`);\n            \n            // // restart ONLY ipfs service \n            // console.log('--Restart via dh-compose restart ipfs--');\n            // var {err, stdout, stderr} = await asyncExec('dh-compose restart ipfs');\n            // console.log(`Exec3 Result: ${stdout} ${stderr}`);\n            \n          \n            // await universe.sleep(25 * 1000);\n            \n            \n            // re-check if ipfs daemon is running now \n            // console.log('Checking if running...');\n            var ipfsSetupResult = await universe.loadAndRunCapability('IPFS',{},{\n              type: 'standard_capability_action:0.0.1:local:298j291bs',\n              data: {\n                action: 'setup',\n                options: {\n                  type: 'ipfs_setup_options:Qmf230j23f232f3',\n                  data: {\n                    preventRestart: true\n                  }\n                }\n              }\n            });\n            \n            \n            return resolve({\n              type: 'boolean',\n              data: true\n            });\n          }\n          break;\n          \n          \n        case 'sync':\n          \n          // get all pins \n          console.log('Getting ID, Pinset');\n          // console.log('PINSET:', universe.IPFS.ipfs.id())\n          var ipfsid = await ipfs.id();\n          console.log('ipfsID:', ipfsid);\n          // console.log('====IPFSid:', ipfsid, typeof ipfsid);\n          var pinset = await ipfs.pin.ls();\n          // console.log('====PINSET:', JSON.stringify(pinset, null, 2));\n          // let addedFiles = await universe.IPFS.ipfs.files.add(new Buffer('testing message 123456789' + (Date.now()),'utf8'))\n          // let newHash = result[0].hash;\n          // let pinResult = await universe.IPFS.ipfs.pin.add(newHash)\n          \n          return resolve({\n            type: 'boolean:..',\n            data: true\n          })\n          \n          break;\n          \n        case 'pin.ls':\n          \n          // get all pins \n          console.log('Getting IPFS Pinset');\n          var pinset = await ipfs.pin.ls();\n          return resolve({\n            type: 'list_of_pins:..',\n            data: pinset\n          })\n          \n          break;\n          \n          \n        case 'file.add':\n          // Add a file (will likely also pin) \n          \n          // expecting utf8 input? \n          let bufferData = new Buffer(inputOpts.data.fileValue, 'utf8'); // expecting type:file_as_string\n          \n          let addResult;\n          try {\n            addResult = await ipfs.files.add(bufferData)\n          }catch(err){\n            console.error('Failed adding to IPFS:', err);\n            return resolve({\n              type: 'boolean:..',\n              data: false\n            });\n          }\n          \n          console.log('Added to IPFS!');\n          \n          let newHash = addResult[0].hash;\n          \n          // also pin?\n          var pinResult;\n          try {\n            if(inputOpts.data.options && inputOpts.data.options.pin){\n              pinResult = await ipfs.pin.add(newHash);\n            }\n          }catch(err){\n            console.error('inputOpts.data.options.pin eRoRoR:', err);\n          }\n            \n          return resolve({\n            type: 'added_file:..',\n            data: {\n              hash: newHash,\n              pinResult\n            }\n          })\n          \n          break;\n          \n        case 'pin.add':\n          // Pin an already-added file \n          var pinResult;\n          try {\n            pinResult = await ipfs.pin.add(INPUT.data.hash)\n          }catch(err){\n            console.error('Failed ipfs pin:', err);\n            return resolve({\n              type: 'boolean:..',\n              data: false\n            });\n          }\n          \n          return resolve({\n            type: 'pin_result:..',\n            data: pinResult\n          })\n          \n          break;\n          \n        case 'pin.rm':\n          // Remove a pin for a file \n          \n          // get all pins \n          console.log('Getting ID, Pinset');\n          // console.log('PINSET:', universe.IPFS.ipfs.id())\n          let removedPin = await ipfs.pin.rm(INPUT.data.hash);\n          \n          return resolve({\n            type: 'pin_result:..',\n            data: removedPin\n          })\n          \n          break;\n          \n        default:\n          console.error('Missing inputAction for capability');\n          return resolve({\n            type: 'error:Qmdsfljk',\n            data: {\n              error: true,\n              message: 'Missing inputAction for capability'\n            }\n          });\n          break;\n      }\n      \n        \n    }catch(err){\n      console.error('IPFS error:', err);\n      resolve({ERROR: true, err: err});\n    }\n    \n    \n  })\n})()"
  }
}